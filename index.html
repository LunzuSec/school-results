<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lunzu Secondary School - Results Viewer</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Roboto+Slab:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #1a3c6e;
            --secondary-color: #3b82f6;
            --accent-color: #7c3aed;
            --light-color: #f8fafc;
            --dark-color: #2d3748;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --white: #fff;
            --gray-light: #e2e8f0;
            --border-radius: 0.75rem;
            --box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            height: 100%;
            -webkit-text-size-adjust: 100%;
        }

        body {
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
        }

        .container {
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header */
        .header-section {
            background: linear-gradient(135deg, var(--primary-color), #4b6cb7);
            color: var(--white);
            text-align: center;
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            position: relative;
            overflow: hidden;
        }

        .header-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
        }

        .school-logo {
            height: clamp(4rem, 10vw, 5rem);
            margin-bottom: 0.75rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            background: white;
            padding: 5px;
        }

        h1, h2, h3, h4, h5 {
            font-family: 'Roboto Slab', serif;
            font-weight: 500;
            line-height: 1.3;
            margin-bottom: 0.5rem;
        }

        h1 { 
            font-size: clamp(28px, 4vw, 36px); 
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        h2 { 
            font-size: clamp(22px, 3vw, 28px); 
            color: #ffd700;
        }
        h3 { 
            font-size: clamp(18px, 2.5vw, 24px); 
            margin-top: 0.5rem;
        }

        /* Main Card */
        .main-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 2rem;
            margin: 2rem auto;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: fadeIn 0.8s ease-out;
            max-width: 800px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Styles */
        .form-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .form-control {
            width: 100%;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            transition: var(--transition);
            background: var(--white);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%232d3748' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 16px 12px;
        }

        /* Search Results */
        .search-results {
            position: absolute;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            border: 2px solid var(--secondary-color);
            border-radius: var(--border-radius);
            margin-top: 0.25rem;
            box-shadow: var(--box-shadow);
            z-index: 1000;
            display: none;
        }

        .search-result-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--gray-light);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: linear-gradient(135deg, var(--light-color), #e3f2fd);
            color: var(--primary-color);
            padding-left: 1.5rem;
        }

        /* Buttons */
        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-width: 180px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #6d28d9);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563, #374151);
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2.5rem;
            flex-wrap: wrap;
        }

        /* Loading */
        .loading-container {
            display: none;
            text-align: center;
            margin: 1.5rem 0;
        }

        .spinner {
            width: 3rem;
            height: 3rem;
            border: 4px solid var(--gray-light);
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--primary-color);
            font-weight: 500;
            font-size: 1.1rem;
        }

        /* Progress Bar */
        .progress-container {
            display: none;
            width: 100%;
            height: 0.5rem;
            background: var(--gray-light);
            border-radius: 1rem;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
            border-radius: 1rem;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Alerts */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .alert-danger {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border-left: 4px solid var(--danger-color);
            color: #721c24;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-left: 4px solid var(--success-color);
            color: #155724;
        }

        .alert-info {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-left: 4px solid var(--warning-color);
            color: #856404;
        }

        /* Footer */
        .footer-section {
            background: linear-gradient(135deg, var(--primary-color), #4b6cb7);
            color: var(--white);
            text-align: center;
            padding: 1.5rem 0;
            margin-top: 3rem;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
            position: relative;
        }

        .footer-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
        }

        .footer-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .footer-content p {
            margin: 0.5rem 0;
            font-size: 1rem;
            opacity: 0.9;
        }

        .footer-content a {
            color: #93c5fd;
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
        }

        .footer-content a:hover {
            color: var(--white);
            text-decoration: underline;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0.75rem;
            }
            
            .main-card {
                padding: 1.5rem;
                margin: 1rem auto;
            }
            
            .btn-group {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .btn {
                min-width: 100%;
                padding: 0.75rem;
            }
            
            h1 {
                font-size: clamp(24px, 5vw, 28px);
            }
            
            h2 {
                font-size: clamp(18px, 4vw, 22px);
            }
        }

        @media (max-width: 480px) {
            .main-card {
                padding: 1rem;
            }
            
            .form-control {
                padding: 0.75rem;
            }
            
            .form-label {
                font-size: 1rem;
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles for keyboard navigation */
        button:focus, input:focus, select:focus {
            outline: 3px solid var(--secondary-color);
            outline-offset: 2px;
        }

        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header-section">
        <div class="container">
            <img src="https://i.ibb.co/LxSJnMj/MALAWI-GOVERNMENT-3.png" 
                 alt="Malawi Government Logo" 
                 class="school-logo">
            <h1>LUNZU SECONDARY SCHOOL</h1>
            <h2>2025-2026 END OF TERM 1 RESULTS</h2>
            <h3>Student Results Portal</h3>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <div class="main-card">
            <h4 class="text-center mb-4">
                <i class="fas fa-user-graduate text-primary"></i> 
                Enter Student Details
            </h4>

            <!-- Form -->
            <form id="studentForm" autocomplete="off" novalidate>
                <!-- Class Selection -->
                <div class="mb-4">
                    <label for="studentClass" class="form-label">
                        <i class="fas fa-users text-primary"></i> 
                        Class:
                    </label>
                    <select id="studentClass" class="form-control form-select" required 
                            onchange="handleClassChange()">
                        <option value="" disabled selected>Select Class</option>
                        <option value="Form 1">Form 1</option>
                        <option value="Form 2">Form 2</option>
                        <option value="Form 3">Form 3</option>
                        <option value="Form 4">Form 4</option>
                        <option value="Form 1 ODL">Form 1 ODL</option>
                        <option value="Form 2 ODL">Form 2 ODL</option>
                        <option value="Form 3 ODL">Form 3 ODL</option>
                        <option value="Form 4 ODL">Form 4 ODL</option>
                    </select>
                    <div class="form-text text-muted">
                        Select the student's class from the list
                    </div>
                </div>

                <!-- Student Search -->
                <div class="mb-4 position-relative">
                    <label for="studentSearch" class="form-label">
                        <i class="fas fa-search text-primary"></i> 
                        Search Student:
                    </label>
                    <input type="text" id="studentSearch" class="form-control" 
                           placeholder="Type student name to search..." 
                           oninput="handleSearchInput()" 
                           disabled 
                           autocomplete="off">
                    <div id="searchResults" class="search-results"></div>
                    <div class="form-text text-muted">
                        Start typing to search for a student
                    </div>
                </div>

                <!-- Student Name Selection -->
                <div class="mb-4">
                    <label for="studentName" class="form-label">
                        <i class="fas fa-user text-primary"></i> 
                        Student Name:
                    </label>
                    <select id="studentName" class="form-control form-select" required>
                        <option value="" disabled selected>Select Student</option>
                    </select>
                    <div class="form-text text-muted">
                        Or select a student from the dropdown
                    </div>
                </div>

                <!-- Date of Birth -->
                <div class="mb-4">
                    <label for="dateOfBirth" class="form-label">
                        <i class="fas fa-calendar-alt text-primary"></i> 
                        Date of Birth:
                    </label>
                    <input type="date" id="dateOfBirth" class="form-control" required>
                    <div class="form-text text-muted">
                        Enter student's date of birth (YYYY-MM-DD)
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" onclick="getResults()">
                        <i class="fas fa-eye"></i> View Results
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="downloadResultsAsPDF()">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                </div>
            </form>

            <!-- Loading Indicator -->
            <div class="loading-container" id="loadingContainer">
                <div class="spinner"></div>
                <p class="loading-text" id="loadingText">Loading...</p>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <!-- Results/Error Container -->
            <div id="resultsContainer"></div>

            <!-- Connection Status -->
            <div id="connectionStatus" class="mt-3"></div>
        </div>

        <!-- API Status -->
        <div class="text-center mt-3">
            <small class="text-white">
                <i class="fas fa-server"></i> API Status: 
                <span id="apiStatus" class="badge bg-success">Connected</span>
            </small>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer-section">
        <div class="footer-content">
            <p>© <span id="current-year"></span> Lunzu Secondary School - Examination Department</p>
            <p>For technical support: 
                <a href="https://wa.me/265888866269" target="_blank">
                    <i class="fab fa-whatsapp"></i> WhatsApp: +265 888 866 269
                </a>
            </p>
            <p class="mt-2">
                <small>
                    <i class="fas fa-shield-alt"></i> 
                    Secure System | 
                    <i class="fas fa-mobile-alt"></i> 
                    Mobile Friendly
                </small>
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Main JavaScript -->
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        // IMPORTANT: Replace with your actual Google Apps Script Web App URL
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwqF45Il1QuX-Kp0hnI11P1QlpUq9hIs288P9LaNVzGgP4XXs-3yDnVXnVnt4lGWHmA/exec';
        
        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        
        let allStudentNames = [];
        let currentStudentClass = '';
        let isOnline = navigator.onLine;
        
        // ============================================
        // UNIVERSAL API CALL FUNCTION
        // ============================================
        
        function callGAS(action, params = {}) {
            return new Promise((resolve, reject) => {
                console.log(`Calling GAS API: ${action}`, params);
                
                // Create unique callback name for JSONP
                const callbackName = 'gas_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Prepare parameters
                const requestParams = {
                    ...params,
                    action: action,
                    callback: callbackName,
                    _: Date.now() // Cache busting
                };
                
                // Build URL for JSONP
                const urlParams = new URLSearchParams();
                for (const key in requestParams) {
                    if (requestParams[key] !== undefined && requestParams[key] !== null) {
                        urlParams.append(key, requestParams[key]);
                    }
                }
                
                const url = GAS_WEB_APP_URL + '?' + urlParams.toString();
                
                // Try JSONP first (works on all browsers)
                const script = document.createElement('script');
                script.src = url;
                
                // Define callback function
                window[callbackName] = function(response) {
                    // Clean up
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    
                    console.log(`API Response for ${action}:`, response);
                    
                    if (response && response.error) {
                        reject(new Error(response.error));
                    } else {
                        resolve(response);
                    }
                };
                
                // Error handling
                script.onerror = function() {
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    
                    // Try fetch as fallback (for modern browsers)
                    if (typeof fetch === 'function') {
                        tryFetch(action, params)
                            .then(resolve)
                            .catch(reject);
                    } else {
                        reject(new Error('Failed to load API. Please check your internet connection.'));
                    }
                };
                
                // Timeout handling
                const timeoutId = setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        reject(new Error('Request timeout. Please try again.'));
                    }
                }, 30000); // 30 second timeout
                
                // Clean up timeout on success/error
                const originalCallback = window[callbackName];
                window[callbackName] = function(response) {
                    clearTimeout(timeoutId);
                    originalCallback(response);
                };
                
                // Add script to document
                document.head.appendChild(script);
            });
        }
        
        // Fallback fetch function for modern browsers
        async function tryFetch(action, params) {
            try {
                const formData = new FormData();
                formData.append('action', action);
                
                for (const key in params) {
                    if (params[key] !== undefined && params[key] !== null) {
                        formData.append(key, params[key]);
                    }
                }
                
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors' // Try no-cors mode
                });
                
                // Note: With no-cors mode, we can't read the response
                // This is just a backup attempt
                throw new Error('Fetch fallback not available for this endpoint');
            } catch (error) {
                throw error;
            }
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Lunzu Results System Initialized');
            
            // Set current year
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            // Initialize form
            resetForm();
            
            // Test API connection
            testAPIConnection();
            
            // Setup offline/online detection
            setupConnectionMonitoring();
            
            // Setup form validation
            setupFormValidation();
            
            // Hide loading indicators
            hideLoading();
        });
        
        // ============================================
        // CONNECTION MONITORING
        // ============================================
        
        function setupConnectionMonitoring() {
            // Monitor online/offline status
            window.addEventListener('online', function() {
                isOnline = true;
                updateConnectionStatus('You are back online', 'success');
                // Retry if we were trying to load names
                if (currentStudentClass) {
                    loadStudentNames(currentStudentClass);
                }
            });
            
            window.addEventListener('offline', function() {
                isOnline = false;
                updateConnectionStatus('You are offline. Some features may not work.', 'warning');
            });
            
            // Initial check
            updateConnectionStatus(isOnline ? 'Online' : 'Offline', isOnline ? 'success' : 'warning');
        }
        
        function updateConnectionStatus(message, type) {
            const statusDiv = document.getElementById('connectionStatus');
            if (!statusDiv) return;
            
            const alertClass = `alert-${type}`;
            statusDiv.innerHTML = `
                <div class="alert ${alertClass}">
                    <i class="fas fa-${type === 'success' ? 'wifi' : 'exclamation-triangle'}"></i>
                    ${message}
                </div>
            `;
            
            // Update API status indicator
            const apiStatus = document.getElementById('apiStatus');
            if (apiStatus) {
                apiStatus.textContent = type === 'success' ? 'Connected' : 'Offline';
                apiStatus.className = `badge bg-${type}`;
            }
        }
        
        // ============================================
        // FORM HANDLING
        // ============================================
        
        function setupFormValidation() {
            const form = document.getElementById('studentForm');
            
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                getResults();
            });
            
            // Real-time validation
            document.getElementById('studentName').addEventListener('change', validateForm);
            document.getElementById('dateOfBirth').addEventListener('change', validateForm);
        }
        
        function validateForm() {
            const studentName = document.getElementById('studentName').value;
            const studentClass = document.getElementById('studentClass').value;
            const dateOfBirth = document.getElementById('dateOfBirth').value;
            
            return studentName && studentClass && dateOfBirth;
        }
        
        function resetForm() {
            document.getElementById('studentForm').reset();
            document.getElementById('studentSearch').disabled = true;
            document.getElementById('studentName').disabled = true;
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('resultsContainer').innerHTML = '';
            hideLoading();
            allStudentNames = [];
            currentStudentClass = '';
        }
        
        // ============================================
        // CLASS AND STUDENT HANDLING
        // ============================================
        
        function handleClassChange() {
            const studentClass = document.getElementById('studentClass').value;
            const studentSearch = document.getElementById('studentSearch');
            const studentNameSelect = document.getElementById('studentName');
            const searchResults = document.getElementById('searchResults');
            
            // Reset related fields
            studentSearch.value = '';
            studentNameSelect.innerHTML = '<option value="" disabled selected>Select Student</option>';
            document.getElementById('dateOfBirth').value = '';
            searchResults.style.display = 'none';
            searchResults.innerHTML = '';
            clearError();
            
            if (studentClass) {
                // Enable fields
                studentSearch.disabled = false;
                studentNameSelect.disabled = false;
                currentStudentClass = studentClass;
                
                // Load student names
                loadStudentNames(studentClass);
            } else {
                studentSearch.disabled = true;
                studentNameSelect.disabled = true;
                currentStudentClass = '';
            }
        }
        
        async function loadStudentNames(studentClass) {
            if (!isOnline) {
                showError('Cannot load student names while offline. Please check your internet connection.');
                return;
            }
            
            showLoading('Loading student list...');
            
            try {
                const names = await callGAS('getStudentNames', { studentClass: studentClass });
                
                if (Array.isArray(names) && names.length > 0) {
                    allStudentNames = names;
                    populateStudentDropdown(names);
                    console.log(`Loaded ${names.length} student names for ${studentClass}`);
                    showSuccess(`Loaded ${names.length} students for ${studentClass}`);
                } else if (Array.isArray(names)) {
                    allStudentNames = [];
                    showInfo(`No students found for ${studentClass}`);
                } else {
                    throw new Error('Invalid response format');
                }
                
                hideLoading();
            } catch (error) {
                console.error('Error loading student names:', error);
                showError(`Failed to load student names: ${error.message}`);
                hideLoading();
            }
        }
        
        function populateStudentDropdown(studentNames) {
            const studentNameSelect = document.getElementById('studentName');
            
            // Clear existing options except the first one
            while (studentNameSelect.options.length > 1) {
                studentNameSelect.remove(1);
            }
            
            // Add student names to dropdown
            studentNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                studentNameSelect.appendChild(option);
            });
            
            // Also update the search functionality
            setupSearchFunctionality();
        }
        
        function setupSearchFunctionality() {
            const studentSearch = document.getElementById('studentSearch');
            const searchResults = document.getElementById('searchResults');
            
            studentSearch.addEventListener('focus', function() {
                if (allStudentNames.length > 0 && this.value === '') {
                    handleSearchInput();
                }
            });
        }
        
        function handleSearchInput() {
            const searchQuery = document.getElementById('studentSearch').value.toLowerCase().trim();
            const searchResults = document.getElementById('searchResults');
            
            if (!searchQuery) {
                searchResults.style.display = 'none';
                return;
            }
            
            // Filter student names
            const filteredNames = allStudentNames.filter(name => 
                name.toLowerCase().includes(searchQuery)
            ).slice(0, 8); // Limit to 8 results
            
            // Display results
            if (filteredNames.length > 0) {
                searchResults.innerHTML = '';
                filteredNames.forEach(name => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item';
                    div.textContent = name;
                    div.onclick = function() {
                        document.getElementById('studentName').value = name;
                        document.getElementById('studentSearch').value = name;
                        searchResults.style.display = 'none';
                        // Scroll to show the selected name
                        document.getElementById('studentName').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    };
                    div.onkeydown = function(event) {
                        if (event.key === 'Enter' || event.key === ' ') {
                            this.click();
                        }
                    };
                    div.tabIndex = 0;
                    searchResults.appendChild(div);
                });
                searchResults.style.display = 'block';
            } else {
                searchResults.innerHTML = '<div class="search-result-item">No students found</div>';
                searchResults.style.display = 'block';
            }
        }
        
        // Close search results when clicking outside
        document.addEventListener('click', function(event) {
            const searchResults = document.getElementById('searchResults');
            const studentSearch = document.getElementById('studentSearch');
            
            if (searchResults.style.display === 'block' && 
                !searchResults.contains(event.target) && 
                event.target !== studentSearch) {
                searchResults.style.display = 'none';
            }
        });
        
        // ============================================
        // MAIN ACTIONS
        // ============================================
        
        async function getResults() {
            // Validate form
            if (!validateForm()) {
                showError('Please fill in all required fields: Class, Student Name, and Date of Birth.');
                return;
            }
            
            // Get form values
            const studentName = document.getElementById('studentName').value.trim();
            const studentClass = document.getElementById('studentClass').value;
            const dateOfBirth = document.getElementById('dateOfBirth').value;
            
            // Validate date format
            if (!isValidDate(dateOfBirth)) {
                showError('Please enter a valid date of birth in YYYY-MM-DD format.');
                return;
            }
            
            // Clear previous errors
            clearError();
            
            // Show loading
            showLoading('Fetching student results...');
            startProgressAnimation();
            
            try {
                // Call API
                const result = await callGAS('getStudentResults', {
                    studentName: studentName,
                    studentClass: studentClass,
                    dateOfBirth: dateOfBirth
                });
                
                // Check for errors
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // Get HTML for results window
                const htmlContent = await callGAS('getResultsWindowHTML', {
                    studentName: studentName,
                    studentClass: studentClass,
                    dateOfBirth: dateOfBirth
                });
                
                // Open results in new window
                openResultsWindow(htmlContent, `${studentName} - ${studentClass} Results`);
                
                // Reset form
                resetForm();
                
            } catch (error) {
                console.error('Error getting results:', error);
                showError(error.message || 'Failed to retrieve results. Please try again.');
            } finally {
                hideLoading();
                stopProgressAnimation();
            }
        }
        
        async function downloadResultsAsPDF() {
            // Validate form
            if (!validateForm()) {
                showError('Please fill in all required fields: Class, Student Name, and Date of Birth.');
                return;
            }
            
            // Get form values
            const studentName = document.getElementById('studentName').value.trim();
            const studentClass = document.getElementById('studentClass').value;
            const dateOfBirth = document.getElementById('dateOfBirth').value;
            
            // Validate date format
            if (!isValidDate(dateOfBirth)) {
                showError('Please enter a valid date of birth in YYYY-MM-DD format.');
                return;
            }
            
            // Clear previous errors
            clearError();
            
            // Show loading
            showLoading('Generating PDF document...');
            startProgressAnimation();
            
            try {
                // Call API
                const pdfBase64 = await callGAS('generatePDF', {
                    studentName: studentName,
                    studentClass: studentClass,
                    dateOfBirth: dateOfBirth
                });
                
                // Download PDF
                downloadPDF(pdfBase64, `${studentName}_${studentClass}_Results.pdf`);
                
                // Reset form
                resetForm();
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showError(error.message || 'Failed to generate PDF. Please try again.');
            } finally {
                hideLoading();
                stopProgressAnimation();
            }
        }
        
        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        
        function isValidDate(dateString) {
            const regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!regex.test(dateString)) return false;
            
            const date = new Date(dateString);
            return date instanceof Date && !isNaN(date);
        }
        
        function showLoading(message) {
            const container = document.getElementById('loadingContainer');
            const text = document.getElementById('loadingText');
            
            text.textContent = message;
            container.style.display = 'block';
            document.getElementById('progressContainer').style.display = 'block';
        }
        
        function hideLoading() {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
        }
        
        function startProgressAnimation() {
            const progressBar = document.getElementById('progressBar');
            let width = 0;
            
            const interval = setInterval(() => {
                if (width >= 90) {
                    clearInterval(interval);
                } else {
                    width += 2;
                    progressBar.style.width = width + '%';
                }
            }, 100);
            
            // Store interval ID for stopping
            window.progressInterval = interval;
        }
        
        function stopProgressAnimation() {
            if (window.progressInterval) {
                clearInterval(window.progressInterval);
            }
            
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = '100%';
            
            // Reset after a delay
            setTimeout(() => {
                progressBar.style.width = '0%';
            }, 500);
        }
        
        function showError(message) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    <strong>Error:</strong> ${message}
                </div>
            `;
            
            // Scroll to error
            container.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function showSuccess(message) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    ${message}
                </div>
            `;
            
            // Auto-hide success messages after 3 seconds
            setTimeout(() => {
                if (container.innerHTML.includes('alert-success')) {
                    container.innerHTML = '';
                }
            }, 3000);
        }
        
        function showInfo(message) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    ${message}
                </div>
            `;
        }
        
        function clearError() {
            document.getElementById('resultsContainer').innerHTML = '';
        }
        
        function openResultsWindow(htmlContent, title) {
            try {
                // Open new window
                const newWindow = window.open('', '_blank');
                
                if (!newWindow) {
                    showError('Please allow pop-ups for this site to view results.');
                    return;
                }
                
                // Set title and write content
                newWindow.document.title = title;
                newWindow.document.write(htmlContent);
                newWindow.document.close();
                
                // Focus the new window
                newWindow.focus();
                
            } catch (error) {
                console.error('Error opening results window:', error);
                showError('Could not open results window. Please try again.');
            }
        }
        
        function downloadPDF(base64Data, fileName) {
            try {
                // Convert base64 to blob
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });
                
                // Create download link
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                link.style.display = 'none';
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                
                showSuccess('PDF downloaded successfully!');
                
            } catch (error) {
                console.error('Error downloading PDF:', error);
                throw new Error('Failed to download PDF: ' + error.message);
            }
        }
        
        // ============================================
        // TEST FUNCTIONS
        // ============================================
        
        async function testAPIConnection() {
            try {
                const result = await callGAS('test', {});
                console.log('✅ API Connection Test:', result);
                
                if (result.status === 'API is working') {
                    updateConnectionStatus('Connected to server', 'success');
                }
            } catch (error) {
                console.error('❌ API connection failed:', error.message);
                updateConnectionStatus('Cannot connect to server. Some features may not work.', 'warning');
            }
        }
        
        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================
        
        document.addEventListener('keydown', function(event) {
            // Ctrl+Enter to submit form
            if (event.ctrlKey && event.key === 'Enter') {
                event.preventDefault();
                getResults();
            }
            
            // Escape to close search results
            if (event.key === 'Escape') {
                const searchResults = document.getElementById('searchResults');
                if (searchResults.style.display === 'block') {
                    searchResults.style.display = 'none';
                }
            }
        });
        
        // ============================================
        // BROWSER COMPATIBILITY CHECK
        // ============================================
        
        function checkBrowserCompatibility() {
            const issues = [];
            
            // Check for required features
            if (typeof atob === 'undefined') {
                issues.push('Base64 decoding (atob) not supported');
            }
            
            if (typeof URL.createObjectURL === 'undefined') {
                issues.push('Blob URLs not supported');
            }
            
            if (typeof Promise === 'undefined') {
                issues.push('Promises not supported');
            }
            
            if (issues.length > 0) {
                console.warn('Browser compatibility issues:', issues);
                showWarning('Your browser may not support all features. Consider updating to a modern browser.');
            }
        }
        
        // Run compatibility check
        setTimeout(checkBrowserCompatibility, 1000);
        
        // ============================================
        // AUTO-SAVE FORM DATA (Optional)
        // ============================================
        
        function saveFormData() {
            const formData = {
                studentClass: document.getElementById('studentClass').value,
                studentName: document.getElementById('studentName').value,
                dateOfBirth: document.getElementById('dateOfBirth').value
            };
            
            try {
                localStorage.setItem('lunzu_last_form', JSON.stringify(formData));
            } catch (e) {
                // Ignore localStorage errors
            }
        }
        
        function loadFormData() {
            try {
                const saved = localStorage.getItem('lunzu_last_form');
                if (saved) {
                    const formData = JSON.parse(saved);
                    if (formData.studentClass) {
                        document.getElementById('studentClass').value = formData.studentClass;
                        handleClassChange();
                        setTimeout(() => {
                            if (formData.studentName) {
                                document.getElementById('studentName').value = formData.studentName;
                            }
                            if (formData.dateOfBirth) {
                                document.getElementById('dateOfBirth').value = formData.dateOfBirth;
                            }
                        }, 1000);
                    }
                }
            } catch (e) {
                // Ignore errors
            }
        }
        
        // Auto-save when form changes
        document.getElementById('studentForm').addEventListener('change', saveFormData);
        
        // Load saved data on page load
        window.addEventListener('load', loadFormData);
    </script>
</body>
</html>
